@inject IJSRuntime JsRuntime
@inject IHostEnvironment HostEnvironment
@inject IUserPreferencesManager PreferencesManager
@inject IOptionsMonitor<PostHogOptions> PostHogOptions
@using System.Security.Claims
@using Arkanis.Overlay.Infrastructure.Options
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.Extensions.Hosting
@using Microsoft.Extensions.Options
@using Microsoft.JSInterop
@using OpenIddict.Abstractions
@implements IDisposable

<script>
    !function (t, e) {
        var o, n, p, r;
        e.__SV || (window.posthog = e, e._i = [], e.init = function (i, s, a) {
            function g(t, e) {
                var o = e.split(".");
                2 == o.length && (t = t[o[0]], e = o[1]), t[e] = function () {
                    t.push([e].concat(Array.prototype.slice.call(arguments, 0)))
                }
            }

            (p = t.createElement("script")).type = "text/javascript", p.crossOrigin = "anonymous", p.async = !0, p.src = s.api_host.replace(".i.posthog.com", "-assets.i.posthog.com") + "/static/array.js", (r = t.getElementsByTagName("script")[0]).parentNode.insertBefore(p, r);
            var u = e;
            for (void 0 !== a ? u = e[a] = [] : a = "posthog", u.people = u.people || [], u.toString = function (t) {
                var e = "posthog";
                return "posthog" !== a && (e += "." + a), t || (e += " (stub)"), e
            }, u.people.toString = function () {
                return u.toString(1) + ".people (stub)"
            }, o = "init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "), n = 0; n < o.length; n++) g(u, o[n]);
            e._i.push([i, s, a])
        }, e.__SV = 1)
    }(document, window.posthog || []);
</script>

@code
{

    [CascadingParameter]
    public Task<AuthenticationState>? AuthenticationState { get; set; }

    protected override void OnInitialized()
        => PreferencesManager.ApplyPreferences += ApplyPreferences;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        try
        {
            await JsRuntime.InvokeVoidAsync(
                "posthog.init",
                PostHogOptions.CurrentValue.ProjectApiKey,
                CreateConfiguration(PreferencesManager.CurrentPreferences)
            );
            await OptInOutAsync();

            var user = AuthenticationState is not null
                ? (await AuthenticationState).User
                : null;

            if (user?.Identity is { IsAuthenticated: true })
            {
                // TODO: new sign-ins won't be tracked
                await JsRuntime.InvokeVoidAsync("posthog.identify", user.GetClaim(ClaimTypes.NameIdentifier));
            }
        }
        catch (JSException)
        {
            // ignore
        }
    }

    private async void ApplyPreferences(object? _, UserPreferences preferences)
    {
        try
        {
            await JsRuntime.InvokeVoidAsync(
                "posthog.set_config",
                CreateConfiguration(PreferencesManager.CurrentPreferences)
            );
            await OptInOutAsync();
        }
        catch
        {
            // ignore
        }
    }

    private async Task OptInOutAsync()
    {
        if (PreferencesManager.CurrentPreferences.PostHogOptions.Enabled)
        {
            await JsRuntime.InvokeVoidAsync("posthog.opt_in_capturing");
        }
        else
        {
            await JsRuntime.InvokeVoidAsync("posthog.opt_out_capturing");
        }
    }

    private object CreateConfiguration(UserPreferences preferences)
        => new
        {
            api_host = PostHogOptions.CurrentValue.ProjectApiHost,
            ui_host = PostHogOptions.CurrentValue.ProjectUiHost,
            defaults = "2025-11-30",
            debug = !HostEnvironment.IsProduction(),
            person_profiles = "identified_only",
            cookieless_mode = "on_reject",
            disable_persistence = true,
            autocapture = preferences.PostHogOptions.Enabled,
            opt_out_capturing_by_default = !preferences.PostHogOptions.Enabled,
            opt_in_capturing_by_default = preferences.PostHogOptions.Enabled,
            error_tracking = preferences.PostHogOptions is { Enabled: true, ErrorReportingEnabled: true },
            capture_pageview = preferences.PostHogOptions is { Enabled: true, PageViewsEnabled: true },
            capture_pageleave = preferences.PostHogOptions is { Enabled: true, PageViewsEnabled: true },
            capture_dead_clicks = preferences.PostHogOptions is { Enabled: true, ClicksEnabled: true },
            rageclick = preferences.PostHogOptions is { Enabled: true, ClicksEnabled: true },
            disable_surveys = preferences.PostHogOptions is { Enabled: false } or { SurveysEnabled: false },
            enable_heatmaps = preferences.PostHogOptions is { Enabled: true, HeatmapsEnabled: true },
            disable_session_recording = preferences.PostHogOptions is { Enabled: false } or { RecordingsEnabled: false },
            bootstrap = new
            {
                distinctID = preferences.InstallationId.ToString(),
                isIdentifiedID = false,
            },
            session_recording = new
            {
                maskAllInputs = true,
                maskTextSelector = ".pii",
            },
        };

    public void Dispose()
        => PreferencesManager.ApplyPreferences -= ApplyPreferences;

}
