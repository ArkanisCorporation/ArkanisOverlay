@using System.Security.Claims
@using Arkanis.Overlay.Infrastructure.Options
@using CitizenId.Domain.Shared.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.Extensions.Hosting
@using Microsoft.Extensions.Options
@using Microsoft.JSInterop
@using OpenIddict.Abstractions
@inject IJSRuntime JsRuntime
@inject IHostEnvironment HostEnvironment
@inject IOptionsMonitor<PostHogOptions> PostHogOptions

<script>
    !function (t, e) {
        var o, n, p, r;
        e.__SV || (window.posthog = e, e._i = [], e.init = function (i, s, a) {
            function g(t, e) {
                var o = e.split(".");
                2 == o.length && (t = t[o[0]], e = o[1]), t[e] = function () {
                    t.push([e].concat(Array.prototype.slice.call(arguments, 0)))
                }
            }

            (p = t.createElement("script")).type = "text/javascript", p.crossOrigin = "anonymous", p.async = !0, p.src = s.api_host.replace(".i.posthog.com", "-assets.i.posthog.com") + "/static/array.js", (r = t.getElementsByTagName("script")[0]).parentNode.insertBefore(p, r);
            var u = e;
            for (void 0 !== a ? u = e[a] = [] : a = "posthog", u.people = u.people || [], u.toString = function (t) {
                var e = "posthog";
                return "posthog" !== a && (e += "." + a), t || (e += " (stub)"), e
            }, u.people.toString = function () {
                return u.toString(1) + ".people (stub)"
            }, o = "init capture register register_once register_for_session unregister unregister_for_session getFeatureFlag getFeatureFlagPayload isFeatureEnabled reloadFeatureFlags updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures on onFeatureFlags onSessionId getSurveys getActiveMatchingSurveys renderSurvey canRenderSurvey getNextSurveyStep identify setPersonProperties group resetGroups setPersonPropertiesForFlags resetPersonPropertiesForFlags setGroupPropertiesForFlags resetGroupPropertiesForFlags reset get_distinct_id getGroups get_session_id get_session_replay_url alias set_config startSessionRecording stopSessionRecording sessionRecordingStarted captureException loadToolbar get_property getSessionProperty createPersonProfile opt_in_capturing opt_out_capturing has_opted_in_capturing has_opted_out_capturing clear_opt_in_out_capturing debug".split(" "), n = 0; n < o.length; n++) g(u, o[n]);
            e._i.push([i, s, a])
        }, e.__SV = 1)
    }(document, window.posthog || []);
</script>

@code
{

    [CascadingParameter]
    public Task<AuthenticationState>? AuthenticationState { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
        {
            return;
        }

        try
        {
            await JsRuntime.InvokeVoidAsync(
                "posthog.init",
                PostHogOptions.CurrentValue.ProjectApiKey,
                new
                {
                    api_host = PostHogOptions.CurrentValue.ProjectApiHost,
                    ui_host = PostHogOptions.CurrentValue.ProjectUiHost,
                    defaults = "2025-11-30",
                    debug = !HostEnvironment.IsProduction(),
                    person_profiles = "identified_only",
                    cookieless_mode = "always",
                    respect_dnt = true,
                    session_recording = new
                    {
                        maskAllInputs = true,
                        maskTextSelector = ".pii",
                    },
                }
            );

            var user = AuthenticationState is not null
                ? (await AuthenticationState).User
                : null;

            if (user?.Identity is { IsAuthenticated: true })
            {
                await JsRuntime.InvokeVoidAsync("posthog.identify", user.GetClaim(ClaimTypes.NameIdentifier));
                await JsRuntime.InvokeVoidAsync(
                    "posthog.setPersonProperties",
                    new
                    {
                        is_verified = user.IsInRole(CitizenIdRoles.Status.Verified),
                    }
                );
            }

            await JsRuntime.InvokeAsync<string>("posthog.get_explicit_consent_status");
            // await JsRuntime.InvokeVoidAsync("posthog.opt_in_capturing");
            // await JsRuntime.InvokeVoidAsync("posthog.opt_out_capturing");
        }
        catch (JSException)
        {
            // ignore
        }
    }
}
