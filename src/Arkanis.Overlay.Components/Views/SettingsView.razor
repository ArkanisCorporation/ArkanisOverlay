@implements IDisposable
@inject IUserPreferencesManager UserPreferencesManager

<!--suppress CssUnusedSymbol, CssUnresolvedCustomProperty -->
<style>
    .external-service-config {
        .mud-expand-panel-header {
            .mud-expand-panel-text {
                display: grid;
                grid-template-columns: minmax(min-content, 1fr) 4fr;
                gap: 8px;
                padding-right: 16px;

                > div {
                    grid-column: auto;
                }

                .mud-chip {
                    margin-top: 0;
                    margin-bottom: 0;
                }
            }
        }
    }
</style>

<SectionContent SectionId="@RenderSections.OverlayControls.BottomRight">
    @* Prevent displaying default content. *@
</SectionContent>

<MudMainContent Class="pb-8 px-2">
    <MudContainer>
        <MudStack>
            <MudPaper>

                <div class="py-4 px-6">
                    <MudText Typo="@Typo.h5">
                        Preferences
                    </MudText>
                    <MudText Typo="@Typo.body1">
                        Customize your experience by adjusting application settings and preferences.
                    </MudText>
                </div>

                <MudDivider/>

                <UserPreferencesControls
                    Preferences="@UserPreferencesManager.CurrentPreferences"
                    @bind-IsValid="@_isValid"/>
            </MudPaper>

            <MudPaper>
                <div class="py-4 px-6">
                    <MudText Typo="@Typo.h5">
                        External Services
                    </MudText>
                    <MudText Typo="@Typo.body1">
                        Link your account to supported external services to enable additional or enhanced features.
                    </MudText>
                </div>

                <MudDivider/>

                <ExternalAccountControls
                    ContentId="@ContentId"/>
            </MudPaper>
        </MudStack>
    </MudContainer>
</MudMainContent>

@code
{

    private const string ContentId = "settings";

    private bool _isValid;

    private async void PerformUpdate(object? _, UserPreferences preferences)
    {
        try
        {
            await InvokeAsync(StateHasChanged);
        }
        catch
        {
            // ignore
        }
    }

    protected override void OnInitialized()
    {
        UserPreferencesManager.ApplyPreferences += PerformUpdate;
    }

    public void Dispose()
    {
        UserPreferencesManager.ApplyPreferences -= PerformUpdate;
    }

}
