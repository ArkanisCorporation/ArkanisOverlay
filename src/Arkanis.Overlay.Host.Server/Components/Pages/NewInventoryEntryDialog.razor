@using Arkanis.Overlay.Domain.Abstractions.Game
@using Arkanis.Overlay.Domain.Abstractions.Services
@using Arkanis.Overlay.Domain.Enums
@using Arkanis.Overlay.Domain.Models.Game
@using Arkanis.Overlay.Domain.Models.Inventory
@using Humanizer
@inject IInventoryManager InventoryManager
@inject ILogger<NewInventoryEntryDialog> Logger

<MudDialog DefaultFocus="@DefaultFocus.Element" ContentClass="py-2">
    <TitleContent>
        Select Item or Commodity
    </TitleContent>
    <DialogContent>
        <MudGrid>
            <MudItem xs="12">
                <GameEntitySelectBox
                    Label="Item or commodity"
                    Accept="@(location => location is GameItem or GameCommodity)"
                    @bind-Value="Entity"
                    Required/>
            </MudItem>
            <MudItem xs="12" sm="3">
                <MudTextField
                    Label="Amount"
                    @bind-Value="@_quantity.Amount"
                    InputType="@InputType.Number"
                    Required/>
            </MudItem>
            <MudItem xs="12" sm="2">
                <MudSelect Label="Unit"
                           @bind-Value="@_quantity.Unit">
                    @foreach (var unit in Enum.GetValues<Quantity.UnitType>().Except([Quantity.UnitType.Undefined]))
                    {
                        <MudSelectItem Value="@unit">
                            @unit.Humanize()
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="7">
                <InventoryListSelect
                    @bind-Value="@List"/>
            </MudItem>
            <MudItem xs="12">
                <GameEntitySelectBox
                    Label="Location"
                    EntityCategory="@GameEntityCategory.Location"
                    Accept="@(location => location is GameSpaceStation or GameCity or GameOutpost)"
                    @bind-Value="Location"/>
            </MudItem>
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="@Cancel">Cancel</MudButton>
        <MudButton Color="@Color.Success"
                   OnClick="@SubmitAsync"
                   Disabled="@(!CanSubmit)">
            Submit
        </MudButton>
    </DialogActions>
</MudDialog>

@code
{

    private readonly Quantity _quantity = new(1, Quantity.UnitType.Count);

    private bool CanSubmit
        => Entity is not null && _quantity.Amount > 0;

    [CascadingParameter]
    public required IMudDialogInstance MudDialog { get; set; }

    [Parameter]
    public IGameEntity? Entity { get; set; }

    [Parameter]
    public IGameEntity? Location { get; set; }

    [Parameter]
    public InventoryEntryList? List { get; set; }

    private async Task SubmitAsync()
    {
        var inventoryEntry = CreateInventoryEntry();
        await InventoryManager.UpdateEntryAsync(inventoryEntry);
        MudDialog.Close(DialogResult.Ok(Entity));
    }

    private InventoryEntryBase CreateInventoryEntry()
        => Entity switch
        {
            GameItem item => Location is IGameLocation location
                ? InventoryEntry.CreateAt(item, _quantity, location, List)
                : InventoryEntry.Create(item, _quantity, List),
            GameCommodity commodity => Location is IGameLocation location
                ? InventoryEntry.CreateAt(commodity, _quantity, location, List)
                : InventoryEntry.Create(commodity, _quantity, List),
            _ => throw new NotSupportedException($"Unable to create appropriate inventory entry for: {Entity}"),
        };

    private void Cancel()
        => MudDialog.Cancel();

    public static async Task<InventoryEntryBase?> ShowAsync(IDialogService dialogService, IGameEntity? entity = null, IGameLocation? location = null)
    {
        var dialogParameters = new DialogParameters<NewInventoryEntryDialog>
        {
            [nameof(Entity)] = entity,
            [nameof(Location)] = location,
        };
        var dialogOptions = new DialogOptions
        {
            FullWidth = true,
            MaxWidth = MaxWidth.Small,
            CloseOnEscapeKey = true,
            CloseButton = true,
        };

        var dialogRef = await dialogService.ShowAsync<NewInventoryEntryDialog>(null, dialogParameters, dialogOptions);
        return await dialogRef.GetReturnValueAsync<InventoryEntryBase>();
    }

}
